<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Route Planning System</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #4a90e2;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #4a90e2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
            position: relative;
        }

        .sidebar {
            width: 400px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 2px solid #4a90e2;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .toggle-sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            border: none;
            color: #4a90e2;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .toggle-sidebar:hover {
            background: #4a90e2;
            color: white;
            transform: scale(1.1);
        }

        .section {
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(74, 144, 226, 0.3);
            backdrop-filter: blur(10px);
        }

        .section h3 {
            color: #4a90e2;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #b0c4de;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(74, 144, 226, 0.5);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .btn {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .vehicle-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(74, 144, 226, 0.3);
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .vehicle-card:hover {
            background: rgba(74, 144, 226, 0.2);
            transform: translateY(-2px);
        }

        .vehicle-card.selected {
            background: rgba(74, 144, 226, 0.4);
            border-color: #4a90e2;
        }

        .vehicle-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .priority-indicators {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .priority-medium {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .priority-low {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .route-info {
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 144, 226, 0.5);
            min-width: 300px;
            z-index: 1000;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .checkpoint-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .checkpoint-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border-left: 4px solid #4a90e2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-suggestions {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .suggestion-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(74, 144, 226, 0.3);
            border-radius: 50%;
            border-top-color: #4a90e2;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .map-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .layer-control {
            margin-bottom: 0.5rem;
        }

        .layer-control label {
            color: #b0c4de;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .layer-control input[type="radio"] {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ°Ô∏è Defense Route Planning System</h1>
    </div>

    <div class="container">
        <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞</button>
        
        <div class="sidebar" id="sidebar">
            <!-- Mission Planning Section -->
            <div class="section">
                <h3>üéØ Mission Planning</h3>
                <div class="form-group">
                    <label>Mission Type:</label>
                    <select class="form-control" id="missionType">
                        <option value="convoy">Convoy Movement</option>
                        <option value="patrol">Patrol Route</option>
                        <option value="supply">Supply Run</option>
                        <option value="troop_movement">Troop Movement</option>
                        <option value="emergency">Emergency Response</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority Level:</label>
                    <select class="form-control" id="priorityLevel">
                        <option value="high">üî¥ High Priority</option>
                        <option value="medium">üü° Medium Priority</option>
                        <option value="low">üü¢ Low Priority</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expected Personnel:</label>
                    <input type="number" class="form-control" id="personnelCount" placeholder="Number of personnel" min="1">
                </div>
            </div>

            <!-- Route Planning Section -->
            <div class="section">
                <h3>üó∫Ô∏è Route Planning</h3>
                <div class="form-group">
                    <label>Start Location:</label>
                    <input type="text" class="form-control" id="startLocation" placeholder="Enter start location or click on map">
                    <button class="btn btn-small" onclick="getCurrentLocation('start')" style="margin-top: 0.5rem;">üìç Use Current Location</button>
                </div>
                <div class="form-group">
                    <label>Destination:</label>
                    <input type="text" class="form-control" id="endLocation" placeholder="Enter destination or click on map">
                </div>
                <div class="form-group">
                    <label>Terrain Type:</label>
                    <select class="form-control" id="terrainType">
                        <option value="mixed">Mixed Terrain</option>
                        <option value="mountain">Mountain</option>
                        <option value="plain">Plain</option>
                        <option value="urban">Urban</option>
                        <option value="desert">Desert</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="planRoute()">üöÄ Plan Route</button>
                <button class="btn btn-warning" onclick="optimizeRoute()">‚ö° AI Optimize</button>
            </div>

            <!-- Vehicle Selection Section -->
            <div class="section">
                <h3>üöõ Vehicle Fleet</h3>
                <div class="vehicle-grid" id="vehicleGrid">
                    <!-- Vehicle cards will be populated by JavaScript -->
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Total Load Capacity (tons):</label>
                    <input type="number" class="form-control" id="totalLoad" step="0.1" placeholder="Enter total load">
                </div>
            </div>

            <!-- Checkpoints Section -->
            <div class="section">
                <h3>üîç Traffic Check Posts</h3>
                <button class="btn btn-small" onclick="addCheckpoint()">‚ûï Add TCP</button>
                <button class="btn btn-small" onclick="viewTrafficData()">üìä View Traffic</button>
                <div class="checkpoint-list" id="checkpointList">
                    <!-- Checkpoints will be populated here -->
                </div>
            </div>

            <!-- AI Recommendations -->
            <div class="section">
                <h3>ü§ñ AI Recommendations</h3>
                <div class="ai-suggestions" id="aiSuggestions">
                    <div class="suggestion-item">‚è∞ Calculating optimal route based on current traffic conditions...</div>
                    <div class="suggestion-item">üöõ Analyzing vehicle capacity and load distribution...</div>
                    <div class="suggestion-item">üì° Monitoring real-time TCP data...</div>
                </div>
                <button class="btn" onclick="generateConvoyLayout()">üìã Generate Convoy Layout</button>
            </div>
        </div>

        <div class="map-container">
            <div class="map-controls">
                <div class="layer-control">
                    <label><input type="radio" name="mapLayer" value="streets" checked> Streets</label>
                </div>
                <div class="layer-control">
                    <label><input type="radio" name="mapLayer" value="terrain"> Terrain</label>
                </div>
                <div class="layer-control">
                    <label><input type="radio" name="mapLayer" value="satellite"> Satellite</label>
                </div>
            </div>
            
            <div id="map"></div>
            
            <div class="route-info" id="routeInfo" style="display: none;">
                <h4>üìç Route Information</h4>
                <div id="routeDetails"></div>
                <div class="priority-indicators" id="priorityIndicators"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.js"></script>

    <script>
        // Global variables
        let map;
        let currentRoute;
        let vehicleMarkers = [];
        let checkpointMarkers = [];
        let selectedVehicles = [];
        let mqttConnection = null;
        let streetsLayer;
        let terrainLayer;
        let satelliteLayer;

        // Vehicle configurations
        const vehicleTypes = {
            truck: { name: 'Heavy Truck', capacity: 10, icon: 'üöõ', personnel: 2, fuel: 'high' },
            jeep: { name: 'Military Jeep', capacity: 1, icon: 'üöô', personnel: 4, fuel: 'medium' },
            miniTruck: { name: 'Mini Truck', capacity: 3, icon: 'üöê', personnel: 2, fuel: 'low' },
            ambulance: { name: 'Ambulance', capacity: 0.5, icon: 'üöë', personnel: 3, fuel: 'medium' },
            bus: { name: 'Bus', capacity: 0, icon: 'üöå', personnel: 50, fuel: 'high' }
        };

        // Initialize the application
        function initializeApp() {
            initializeMap();
            setupVehicleGrid();
            setupEventListeners();
            startMQTTConnection();
            generateAIRecommendations();
        }

        // Initialize map with OpenStreetMap-based layers
        function initializeMap() {
            map = L.map('map').setView([28.7041, 77.1025], 10); // Default to Delhi area

            // Define map layers using OpenStreetMap providers
            streetsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="https://opentopomap.org">OpenTopoMap</a>'
            });

            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.esri.com">Esri</a>, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            // Add default layer
            streetsLayer.addTo(map);

            // Map click event for location selection
            map.on('click', function(e) {
                handleMapClick(e);
            });
        }

        // Setup vehicle selection grid
        function setupVehicleGrid() {
            const vehicleGrid = document.getElementById('vehicleGrid');
            vehicleGrid.innerHTML = '';

            Object.entries(vehicleTypes).forEach(([key, vehicle]) => {
                const vehicleCard = document.createElement('div');
                vehicleCard.className = 'vehicle-card';
                vehicleCard.dataset.vehicleType = key;
                
                vehicleCard.innerHTML = `
                    <div class="vehicle-icon">${vehicle.icon}</div>
                    <div>${vehicle.name}</div>
                    <div style="font-size: 0.8rem; color: #b0c4de; margin-top: 0.5rem;">
                        Capacity: ${vehicle.capacity}t<br>
                        Personnel: ${vehicle.personnel}
                    </div>
                    <input type="number" min="0" max="10" value="0" 
                           onchange="updateVehicleCount('${key}', this.value)"
                           style="width: 60px; margin-top: 0.5rem; padding: 0.25rem; border-radius: 4px; border: 1px solid #4a90e2; background: rgba(255,255,255,0.1); color: #fff; text-align: center;">
                `;
                
                vehicleGrid.appendChild(vehicleCard);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Map layer controls
            document.querySelectorAll('input[name="mapLayer"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    switchMapLayer(this.value);
                });
            });

            // Real-time updates simulation
            setInterval(updateVehiclePositions, 5000);
            setInterval(updateTrafficConditions, 30000);
        }

        // Handle map layer switching
        function switchMapLayer(layerType) {
            // Remove all layers
            map.eachLayer(function(layer) {
                if (layer._url) {
                    map.removeLayer(layer);
                }
            });

            // Add selected layer
            switch(layerType) {
                case 'terrain':
                    terrainLayer.addTo(map);
                    break;
                case 'satellite':
                    satelliteLayer.addTo(map);
                    break;
                default:
                    streetsLayer.addTo(map);
            }
        }

        // Handle map clicks for location selection
        function handleMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Determine if setting start or end location
            const startInput = document.getElementById('startLocation');
            const endInput = document.getElementById('endLocation');
            
            if (!startInput.value) {
                startInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                addLocationMarker(lat, lng, 'Start', 'green');
            } else if (!endInput.value) {
                endInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                addLocationMarker(lat, lng, 'End', 'red');
            }
        }

        // Add location marker
        function addLocationMarker(lat, lng, label, color) {
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>${label} Location</b><br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`);
        }

        // Get current location
        function getCurrentLocation(type) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (type === 'start') {
                        document.getElementById('startLocation').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        addLocationMarker(lat, lng, 'Current Location', 'blue');
                    }
                    
                    map.setView([lat, lng], 15);
                }, function(error) {
                    alert('Geolocation failed: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        // Update vehicle count
        function updateVehicleCount(vehicleType, count) {
            const vehicle = vehicleTypes[vehicleType];
            const index = selectedVehicles.findIndex(v => v.type === vehicleType);
            
            if (count > 0) {
                if (index >= 0) {
                    selectedVehicles[index].count = parseInt(count);
                } else {
                    selectedVehicles.push({
                        type: vehicleType,
                        count: parseInt(count),
                        ...vehicle
                    });
                }
            } else if (index >= 0) {
                selectedVehicles.splice(index, 1);
            }
            
            updateFleetSummary();
        }

        // Update fleet summary
        function updateFleetSummary() {
            const totalCapacity = selectedVehicles.reduce((sum, v) => sum + (v.capacity * v.count), 0);
            const totalPersonnel = selectedVehicles.reduce((sum, v) => sum + (v.personnel * v.count), 0);
            
            // Update AI recommendations
            generateAIRecommendations();
        }

        // Plan route
        function planRoute() {
            const startLocation = document.getElementById('startLocation').value;
            const endLocation = document.getElementById('endLocation').value;
            
            if (!startLocation || !endLocation) {
                alert('Please select both start and end locations.');
                return;
            }
            
            // Clear existing route
            if (currentRoute) {
                map.removeControl(currentRoute);
            }
            
            // Parse coordinates
            const startCoords = parseCoordinates(startLocation);
            const endCoords = parseCoordinates(endLocation);
            
            if (!startCoords || !endCoords) {
                alert('Invalid coordinates format. Use "latitude, longitude" format.');
                return;
            }
            
            // Create route using OSRM
            currentRoute = L.Routing.control({
                waypoints: [
                    L.latLng(startCoords[0], startCoords[1]),
                    L.latLng(endCoords[0], endCoords[1])
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                routeWhileDragging: true,
                createMarker: function(i, waypoint, n) {
                    const marker = L.marker(waypoint.latLng, {
                        draggable: true,
                        icon: L.divIcon({
                            className: 'route-marker',
                            html: `<div style="background: ${i === 0 ? '#28a745' : '#dc3545'}; color: white; padding: 5px; border-radius: 50%; text-align: center; font-weight: bold;">${i === 0 ? 'S' : 'E'}</div>`
                        })
                    });
                    return marker;
                }
            }).addTo(map);
            
            // Show route information
            showRouteInfo();
        }

        // Parse coordinates from string
        function parseCoordinates(coordString) {
            const coords = coordString.split(',').map(c => parseFloat(c.trim()));
            if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                return coords;
            }
            return null;
        }

        // Show route information
        function showRouteInfo() {
            const routeInfo = document.getElementById('routeInfo');
            const routeDetails = document.getElementById('routeDetails');
            const priorityLevel = document.getElementById('priorityLevel').value;
            const missionType = document.getElementById('missionType').value;
            
            routeDetails.innerHTML = `
                <div><span class="status-indicator status-online"></span>Route Status: Active</div>
                <div>Mission: ${missionType.replace('_', ' ').toUpperCase()}</div>
                <div>Priority: ${priorityLevel.toUpperCase()}</div>
                <div>Vehicles: ${selectedVehicles.length} types selected</div>
                <div>Estimated Time: Calculating...</div>
                <div>Traffic Conditions: Monitoring...</div>
            `;
            
            const priorityIndicators = document.getElementById('priorityIndicators');
            priorityIndicators.innerHTML = `<div class="priority-badge priority-${priorityLevel}">${priorityLevel.toUpperCase()}</div>`;
            
            routeInfo.style.display = 'block';
        }

        // Optimize route with AI
        function optimizeRoute() {
            if (!currentRoute) {
                alert('Please plan a route first.');
                return;
            }
            
            // Simulate AI optimization
            const aiSuggestions = document.getElementById('aiSuggestions');
            aiSuggestions.innerHTML = `
                <div class="suggestion-item">ü§ñ AI Analysis: Route optimization in progress... <span class="loading"></span></div>
                <div class="suggestion-item">üìä Traffic Analysis: Current congestion levels analyzed</div>
                <div class="suggestion-item">üõ°Ô∏è Security Assessment: Threat level evaluation complete</div>
                <div class="suggestion-item">‚õΩ Fuel Optimization: Most efficient route calculated</div>
                <div class="suggestion-item">üéØ Convoy Spacing: Optimal VTKM recommendation: 50m</div>
            `;
            
            setTimeout(() => {
                aiSuggestions.innerHTML = `
                    <div class="suggestion-item">‚úÖ Optimized route reduces travel time by 15%</div>
                    <div class="suggestion-item">üöõ Recommended convoy formation: Lead-Body-Tail</div>
                    <div class="suggestion-item">‚è∞ Best departure time: 0600 hours</div>
                    <div class="suggestion-item">üîÑ Alternative route available for high-risk areas</div>
                    <div class="suggestion-item">üìç Next TCP checkpoint: 12.5 km ahead</div>
                `;
            }, 3000);
        }

        // Add checkpoint
        function addCheckpoint() {
            const checkpointName = prompt('Enter checkpoint name:');
            if (!checkpointName) return;
            
            // Add checkpoint at map center
            const center = map.getCenter();
            const checkpoint = {
                id: Date.now(),
                name: checkpointName,
                lat: center.lat,
                lng: center.lng,
                status: 'active',
                lastUpdate: new Date()
            };
            
            // Add marker to map
            const marker = L.marker([center.lat, center.lng], {
                icon: L.divIcon({
                    className: 'checkpoint-marker',
                    html: `<div style="background: #ffc107; color: black; padding: 8px; border-radius: 8px; font-weight: bold; border: 2px solid #fff;">üöß ${checkpointName}</div>`
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <b>TCP: ${checkpointName}</b><br>
                Status: <span style="color: #28a745;">Active</span><br>
                Last Update: ${checkpoint.lastUpdate.toLocaleTimeString()}<br>
                <button onclick="updateCheckpointStatus('${checkpoint.id}')">Update Status</button>
            `);
            
            checkpointMarkers.push({ marker, data: checkpoint });
            updateCheckpointList();
        }

        // Update checkpoint status
        function updateCheckpointStatus(checkpointId) {
            const checkpoint = checkpointMarkers.find(cp => cp.data.id == checkpointId);
            if (checkpoint) {
                const newStatus = prompt('Enter new status (e.g., active, inactive):', checkpoint.data.status);
                if (newStatus) {
                    checkpoint.data.status = newStatus;
                    checkpoint.data.lastUpdate = new Date();
                    checkpoint.marker.bindPopup(`
                        <b>TCP: ${checkpoint.data.name}</b><br>
                        Status: <span style="color: ${newStatus === 'active' ? '#28a745' : '#dc3545'}">${newStatus}</span><br>
                        Last Update: ${checkpoint.data.lastUpdate.toLocaleTimeString()}<br>
                        <button onclick="updateCheckpointStatus('${checkpoint.data.id}')">Update Status</button>
                    `);
                    updateCheckpointList();
                }
            }
        }

        // Update checkpoint list
        function updateCheckpointList() {
            const checkpointList = document.getElementById('checkpointList');
            checkpointList.innerHTML = '';
            
            checkpointMarkers.forEach(cp => {
                const checkpointItem = document.createElement('div');
                checkpointItem.className = 'checkpoint-item';
                checkpointItem.innerHTML = `
                    <div>
                        <strong>${cp.data.name}</strong><br>
                        <small>Status: ${cp.data.status} | ${cp.data.lastUpdate.toLocaleTimeString()}</small>
                    </div>
                    <button class="btn btn-small btn-warning" onclick="removeCheckpoint('${cp.data.id}')">Remove</button>
                `;
                checkpointList.appendChild(checkpointItem);
            });
        }

        // Remove checkpoint
        function removeCheckpoint(checkpointId) {
            const index = checkpointMarkers.findIndex(cp => cp.data.id == checkpointId);
            if (index >= 0) {
                map.removeLayer(checkpointMarkers[index].marker);
                checkpointMarkers.splice(index, 1);
                updateCheckpointList();
            }
        }

        // View traffic data
        function viewTrafficData() {
            // Switch to streets layer (as traffic layer isn't available in OpenStreetMap)
            document.querySelector('input[name="mapLayer"][value="streets"]').checked = true;
            switchMapLayer('streets');
            
            // Show simulated traffic analysis
            const aiSuggestions = document.getElementById('aiSuggestions');
            aiSuggestions.innerHTML = `
                <div class="suggestion-item">üìä Traffic Analysis Active</div>
                <div class="suggestion-item">üö¶ Current Congestion: Moderate on primary routes</div>
                <div class="suggestion-item">üïê Peak Hours: 08:00-10:00, 17:00-19:00</div>
                <div class="suggestion-item">üîÑ Alternative Routes: 2 available</div>
                <div class="suggestion-item">üìà Traffic Prediction: Light traffic expected in 2 hours</div>
            `;
        }

        // Generate convoy layout
        function generateConvoyLayout() {
            if (selectedVehicles.length === 0) {
                alert('Please select vehicles first.');
                return;
            }
            
            const priorityLevel = document.getElementById('priorityLevel').value;
            const personnelCount = document.getElementById('personnelCount').value || 0;
            const totalLoad = document.getElementById('totalLoad').value || 0;
            
            // Calculate convoy requirements
            const totalCapacity = selectedVehicles.reduce((sum, v) => sum + (v.capacity * v.count), 0);
            const totalPersonnelCapacity = selectedVehicles.reduce((sum, v) => sum + (v.personnel * v.count), 0);
            
            // Generate convoy layout
            let convoyLayout = `
                <h4>üöõ Convoy Movement Instructions</h4>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h5>Formation Layout:</h5>
                    <div style="margin: 0.5rem 0;">
                        <strong>Lead Vehicle:</strong> ${selectedVehicles.find(v => v.type === 'jeep') ? 'Military Jeep (Reconnaissance)' : 'Available vehicle'}
                    </div>
                    <div style="margin: 0.5rem 0;">
                        <strong>Main Body:</strong> ${selectedVehicles.filter(v => v.type === 'truck' || v.type === 'bus').map(v => `${v.count}x ${v.name}`).join(', ')}
                    </div>
                    <div style="margin: 0.5rem 0;">
                        <strong>Tail Vehicle:</strong> ${selectedVehicles.find(v => v.type === 'ambulance') ? 'Ambulance (Medical Support)' : 'Support vehicle'}
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h5>Convoy Specifications:</h5>
                    <div>Total Vehicles: ${selectedVehicles.reduce((sum, v) => sum + v.count, 0)}</div>
                    <div>Load Capacity: ${totalCapacity} tons</div>
                    <div>Personnel Capacity: ${totalPersonnelCapacity} persons</div>
                    <div>VTKM Recommendation: ${priorityLevel === 'high' ? '100m' : '50m'}</div>
                    <div>Convoy Length: ~${(selectedVehicles.reduce((sum, v) => sum + v.count, 0) * 0.05).toFixed(1)} km</div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h5>Movement Instructions:</h5>
                    <div>‚Ä¢ Departure Time: ${getOptimalDepartureTime()}</div>
                    <div>‚Ä¢ Speed Limit: ${priorityLevel === 'high' ? '60 km/h' : '50 km/h'}</div>
                    <div>‚Ä¢ Communication: Radio check every 15 minutes</div>
                    <div>‚Ä¢ Fuel Status: Check before departure</div>
                    <div>‚Ä¢ Emergency Procedures: Standard SOP applies</div>
                </div>
            `;
            
            // Show convoy layout in popup
            const popup = L.popup()
                .setLatLng(map.getCenter())
                .setContent(convoyLayout)
                .openOn(map);
        }

        // Get optimal departure time
        function getOptimalDepartureTime() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour < 6) return '0600 hours (Current time optimal)';
            if (hour >= 6 && hour < 8) return '0800 hours (Avoid morning traffic)';
            if (hour >= 8 && hour < 17) return 'Immediate departure possible';
            if (hour >= 17 && hour < 19) return '2000 hours (Avoid evening traffic)';
            return '0600 hours next day (Night movement not recommended)';
        }

        // Generate AI recommendations
        function generateAIRecommendations() {
            const missionType = document.getElementById('missionType').value;
            const priorityLevel = document.getElementById('priorityLevel').value;
            const terrainType = document.getElementById('terrainType').value;
            
            const recommendations = [
                `üéØ Mission Type: ${missionType.replace('_', ' ').toUpperCase()} - ${getMissionRecommendation(missionType)}`,
                `üèîÔ∏è Terrain: ${terrainType.toUpperCase()} - ${getTerrainRecommendation(terrainType)}`,
                `‚ö° Priority: ${priorityLevel.toUpperCase()} - ${getPriorityRecommendation(priorityLevel)}`,
                `üöõ Fleet: ${getFleetRecommendation()}`,
                `üìç Route: ${getRouteRecommendation()}`
            ];
            
            const aiSuggestions = document.getElementById('aiSuggestions');
            aiSuggestions.innerHTML = recommendations.map(rec => `<div class="suggestion-item">${rec}</div>`).join('');
        }

        // Get mission-specific recommendations
        function getMissionRecommendation(mission) {
            const recommendations = {
                convoy: 'Maintain 50m spacing, radio check every 15min',
                patrol: 'Variable speed, random stops recommended',
                supply: 'Heavy vehicles, fuel efficiency priority',
                troop_movement: 'Bus formation, personnel comfort priority',
                emergency: 'Speed priority, clear traffic lanes'
            };
            return recommendations[mission] || 'Standard convoy procedures';
        }

        // Get terrain-specific recommendations
        function getTerrainRecommendation(terrain) {
            const recommendations = {
                mountain: 'Reduced speed 40km/h, engine braking, wider spacing',
                plain: 'Standard speed 60km/h, fuel efficiency optimal',
                urban: 'Traffic awareness, 30km/h in populated areas',
                desert: 'Heat management, extra water, sand protection',
                mixed: 'Adaptive speed, terrain-specific precautions'
            };
            return recommendations[terrain] || 'Standard terrain procedures';
        }

        // Get priority-specific recommendations
        function getPriorityRecommendation(priority) {
            const recommendations = {
                high: 'Immediate departure, traffic override, security escort',
                medium: 'Optimal timing, traffic consideration, standard security',
                low: 'Fuel efficiency, traffic avoidance, scheduled departure'
            };
            return recommendations[priority] || 'Standard priority procedures';
        }

        // Get fleet recommendations
        function getFleetRecommendation() {
            if (selectedVehicles.length === 0) {
                return 'No vehicles selected - please select fleet';
            }
            
            const totalCapacity = selectedVehicles.reduce((sum, v) => sum + (v.capacity * v.count), 0);
            const totalVehicles = selectedVehicles.reduce((sum, v) => sum + v.count, 0);
            
            return `${totalVehicles} vehicles, ${totalCapacity}t capacity - ${totalCapacity > 20 ? 'Heavy convoy' : 'Standard convoy'}`;
        }

        // Get route recommendations
        function getRouteRecommendation() {
            if (!currentRoute) {
                return 'No route planned - please plan route';
            }
            return 'Route active - monitoring traffic conditions';
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Start MQTT connection simulation
        function startMQTTConnection() {
            console.log('MQTT Connection initialized for real-time vehicle tracking');
            // Simulate MQTT connection
            simulateVehicleData();
        }

        // Simulate vehicle data via MQTT
        function simulateVehicleData() {
            // Simulate real-time vehicle position updates
            setInterval(() => {
                updateVehiclePositions();
            }, 5000);
        }

        // Update vehicle positions (simulation)
        function updateVehiclePositions() {
            // Remove existing vehicle markers
            vehicleMarkers.forEach(marker => map.removeLayer(marker));
            vehicleMarkers = [];
            
            // Add simulated vehicle positions
            selectedVehicles.forEach((vehicle, index) => {
                for (let i = 0; i < vehicle.count; i++) {
                    const lat = 28.7041 + (Math.random() - 0.5) * 0.1;
                    const lng = 77.1025 + (Math.random() - 0.5) * 0.1;
                    
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'vehicle-marker',
                            html: `<div style="background: #4a90e2; color: white; padding: 5px; border-radius: 50%; text-align: center; font-size: 1.2rem;">${vehicle.icon}</div>`
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <b>${vehicle.name}</b><br>
                        Status: <span style="color: #28a745;">Active</span><br>
                        Speed: ${Math.floor(Math.random() * 60 + 20)} km/h<br>
                        Fuel: ${Math.floor(Math.random() * 50 + 50)}%<br>
                        Last Update: ${new Date().toLocaleTimeString()}
                    `);
                    
                    vehicleMarkers.push(marker);
                }
            });
        }

        // Update traffic conditions
        function updateTrafficConditions() {
            // Simulate traffic condition updates
            const conditions = ['Light', 'Moderate', 'Heavy', 'Congested'];
            const currentCondition = conditions[Math.floor(Math.random() * conditions.length)];
            
            // Update route info if visible
            const routeInfo = document.getElementById('routeInfo');
            if (routeInfo.style.display !== 'none') {
                const routeDetails = document.getElementById('routeDetails');
                const currentContent = routeDetails.innerHTML;
                routeDetails.innerHTML = currentContent.replace(
                    /Traffic Conditions: .*?</,
                    `Traffic Conditions: ${currentCondition}<`
                );
            }
        }

        // Calculate bus requirements for troop movement
        function calculateBusRequirements() {
            const personnelCount = parseInt(document.getElementById('personnelCount').value) || 0;
            const busCapacity = vehicleTypes.bus.personnel;
            const requiredBuses = Math.ceil(personnelCount / busCapacity);
            
            if (personnelCount > 0) {
                document.querySelector('[data-vehicle-type="bus"] input').value = requiredBuses;
                updateVehicleCount('bus', requiredBuses);
                
                // Update AI recommendations
                const aiSuggestions = document.getElementById('aiSuggestions');
                aiSuggestions.innerHTML = `
                    <div class="suggestion-item">üë• Personnel: ${personnelCount} soldiers</div>
                    <div class="suggestion-item">üöå Required Buses: ${requiredBuses} (${busCapacity} capacity each)</div>
                    <div class="suggestion-item">üìã Formation: Standard troop movement convoy</div>
                    <div class="suggestion-item">üõ°Ô∏è Security: Lead and tail security vehicles recommended</div>
                `;
            }
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Auto-calculate bus requirements when personnel count changes
            document.getElementById('personnelCount').addEventListener('input', function() {
                if (document.getElementById('missionType').value === 'troop_movement') {
                    calculateBusRequirements();
                }
            });
            
            // Update recommendations when mission type changes
            document.getElementById('missionType').addEventListener('change', function() {
                generateAIRecommendations();
                if (this.value === 'troop_movement') {
                    calculateBusRequirements();
                }
            });
            
            // Update recommendations when other parameters change
            ['priorityLevel', 'terrainType'].forEach(id => {
                document.getElementById(id).addEventListener('change', generateAIRecommendations);
            });
        });

        // Export convoy data
        function exportConvoyData() {
            const convoyData = {
                mission: document.getElementById('missionType').value,
                priority: document.getElementById('priorityLevel').value,
                terrain: document.getElementById('terrainType').value,
                vehicles: selectedVehicles,
                checkpoints: checkpointMarkers.map(cp => cp.data),
                route: currentRoute ? 'Active' : 'Not planned',
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(convoyData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `convoy_plan_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Print convoy instructions
        function printConvoyInstructions() {
            const printWindow = window.open('', '_blank');
            const convoyData = generateConvoyLayout();
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Convoy Movement Instructions</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                            .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
                            .classified { color: red; font-weight: bold; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>CONVOY MOVEMENT INSTRUCTIONS</h1>
                            <div class="classified">RESTRICTED DOCUMENT</div>
                        </div>
                        <div class="section">
                            <h3>Mission Details</h3>
                            <p>Mission Type: ${document.getElementById('missionType').value.toUpperCase()}</p>
                            <p>Priority Level: ${document.getElementById('priorityLevel').value.toUpperCase()}</p>
                            <p>Date: ${new Date().toLocaleDateString()}</p>
                            <p>Time: ${new Date().toLocaleTimeString()}</p>
                        </div>
                        <div class="section">
                            <h3>Vehicle Allocation</h3>
                            ${selectedVehicles.map(v => `<p>${v.count}x ${v.name} (${v.icon})</p>`).join('')}
                        </div>
                        <div class="section">
                            <h3>Route Information</h3>
                            <p>Start: ${document.getElementById('startLocation').value || 'Not specified'}</p>
                            <p>End: ${document.getElementById('endLocation').value || 'Not specified'}</p>
                            <p>Terrain: ${document.getElementById('terrainType').value.toUpperCase()}</p>
                        </div>
                        <div class="section">
                            <h3>Safety Instructions</h3>
                            <p>‚Ä¢ Maintain radio communication at all times</p>
                            <p>‚Ä¢ Follow prescribed convoy spacing</p>
                            <p>‚Ä¢ Report any incidents immediately</p>
                            <p>‚Ä¢ Adhere to traffic rules and regulations</p>
                        </div>
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>